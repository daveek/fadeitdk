[
  {
    "id": "nginx-referer-spam-blacklist",
    "title": "Blacklist Referer Spam Bots with NGINX",
    "intro": "Seeing weird things in your Google Analytics dashboard? Here's an easy approach for blacklisting Referer Spam Bots with NGINX.",
    "cover": "cover_wide.jpg",
    "date": "2015-04-20T15:10:00.000Z",
    "author": {
      "name": "Justas Azna",
      "gplus": "https://www.google.com/+JustasAzna?rel=author",
      "photo": "src/assets/img/team/fadeit_team_justas_azna.jpg",
      "job_title": "Software engineer"
    },
    "content": [
      {
        "type": "h",
        "text": "Some Background"
      },
      {
        "type": "p",
        "text": "Recently, we submitted fadeit.dk to <a href=\"http://www.awwwards.com/best-websites/fadeit-1/\" target=\"_blank\">AWWWARDS</a> - the awards for design, creativity and innovation on the Internet. It gave us a nice little boost of website visitors. However, not all of that attention was positive..."
      },
      {
        "type": "h",
        "text": "Referer Spam Bots"
      },
      {
        "type": "p",
        "text": "While the majority of our traffic came from genuine sources, we started noticing a pattern in our referral traffic."
      },
      {
        "type": "img",
        "url": "posts/nginx-referer-spam-blacklist/ga_dashboard.png",
        "caption": "Google Analytics Dashboard - Acquisition / Referrals"
      },
      {
        "type": "p",
        "text": ""
      },
      {
        "type": "p",
        "text": "What's up with <em>social-buttons.com</em>? We didn't sign up for that... Apparently, this is something called <a href=\"http://en.wikipedia.org/wiki/Referer_spam\" target=\"_blank\">Referer Spam</a>*:"
      },
      {
        "type": "quote",
        "text": "Referrer spam (also known as log spam or referrer bombing) is a kind of spamdexing (spamming aimed at search engines). The technique involves making repeated web site requests using a fake referer URL to the site the spammer wishes to advertise. Sites that publish their access logs, including referer statistics, will then inadvertently link back to the spammer's site. These links will be indexed by search engines as they crawl the access logs. - Wikipedia",
        "ref": "http://en.wikipedia.org/wiki/Referer_spam",
        "reverse": true
      },
      {
        "type": "p",
        "text": "This is not cool, Mr. social-buttons.com. P**s off!"
      },
      {
        "type": "p",
        "text": "<i>* No, I didn't mispell. The mispelling actually made it into the <a href=\"http://tools.ietf.org/html/rfc1945\" target=\"_blank\">HTTP/1.0 standard</a> and now it's there forever :)</i>"
      },
      {
        "type": "h",
        "text": "NGINX Solution"
      },
      {
        "type": "p",
        "text": "Since we're using NGINX to serve our site, the solution is going to be described for NGINX. Apache people can take a look at this excellent <a href=\"https://www.addedbytes.com/blog/block-referrer-spam/\" target=\"_blank\">article</a>."
      },
      {
        "type": "p",
        "text": "The official NGINX wiki does mention <a href=\"http://wiki.nginx.org/Referrer_Spam_Blocking\" target=\"_blank\">a solution</a> to this problem. Basically, you just use <a href=\"http://nginx.org/en/docs/http/ngx_http_referer_module.html\" target=\"_blank\">ngx_http_referer_module</a>* and add something like this to your location or server block:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "valid_referers.conf.txt"
      },
      {
        "type": "p",
        "text": "This works, but what if we want to maintain a larger blacklist of referers? Our <em>valid_referers</em> directive would get crazy long. If that's fine with you, you can stop reading here. It sure isn't fine with me :)."
      },
      {
        "type": "p",
        "text": "In order to make our blacklist more maintainable, we can use <a href=\"http://nginx.org/en/docs/http/ngx_http_map_module.html\" target=\"_blank\">ngx_http_map_module</a>. Let's save <em>/etc/nginx/blacklist.conf</em> file with the following content:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "blacklist.conf.txt"
      },
      {
        "type": "p",
        "text": "Now include the file the the http block of your <em>/etc/nginx/nginx.conf</em> file:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "nginx.conf.txt"
      },
      {
        "type": "p",
        "text": "All that's left is to add conditions to the sites, for which, you want to block referer spam bots:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "mysite.conf.txt"
      },
      {
        "type": "p",
        "text": "OK, now let's test if this thing works:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "test_if_works.bash.txt"
      },
      {
        "type": "p",
        "text": "Sweet! It worked."
      },
      {
        "type": "p",
        "text": "<i>* Both <a href=\"http://nginx.org/en/docs/http/ngx_http_referer_module.html\" target=\"_blank\">ngx_http_referer_module</a> and <a href=\"http://nginx.org/en/docs/http/ngx_http_map_module.html\" target=\"_blank\">ngx_http_map_module</a> are included in the standard NGINX distribution and you don't need to recompile your server.</i>"
      },
      {
        "type": "h",
        "text": "That's it!"
      },
      {
        "type": "p",
        "text": "What's your experience with Referer Spam? Don't hesitate to use the comment section :)"
      },
      {
        "type": "h",
        "text": "Additional Resources"
      },
      {
        "type": "p",
        "text": ""
      },
      {
        "type": "list",
        "items": {
          "0": "<a href=\"https://github.com/oohnoitz/nginx-blacklist\" target=\"_blank\">Blacklist by oohnoitz</a> which blocks bad bots, pentest tools, surveillance bots, etc. It's an excellent addition to the referer spam blacklist described in this post.",
          "1": "<a href=\"http://perishablepress.com/4g-ultimate-referrer-blacklist/\" target=\"_blank\">Ultimate referer blacklist</a>"
        }
      }
    ]
  }
]
