[
  {
    "id": "testing-express-couchdb-apps-with-mock-couch",
    "title": "Testing Express.js + CouchDB Applications with mock-couch",
    "intro": "There's a way to test Express.js + CouchDB web apps with confidence of end-to-end tests and execution speed of unit-tests. Meet mock-couch- a node.js module which pretends to be a CouchDB server for testing purposes.",
    "cover": "cover.jpg",
    "date": "2015-07-05T20:30:00.000Z",
    "author": {
      "name": "Justas Azna",
      "gplus": "https://www.google.com/+JustasAzna?rel=author",
      "photo": "src/assets/img/team/fadeit_team_justas_azna.jpg",
      "job_title": "Software engineer"
    },
    "content": [
      {
        "type": "h",
        "text": "Prerequisites"
      },
      {
        "type": "p",
        "text": "The code in this post is based upon <a href=\"http://coffeescript.org/\" target=\"_blank\">CoffeeScript</a>, <a href=\"http://mochajs.org/\" target=\"_blank\">Mocha</a> and <a href=\"http://gulpjs.com/\" target=\"_blank\">Gulp</a> but it should be easily adaptable to other stacks (e.g. <a href=\"https://www.javascript.com/\" target=\"_blank\">JavaScript</a>, <a href=\"https://jasmine.github.io/\" target=\"_blank\">Jasmine</a> and <a href=\"http://gruntjs.com/\" target=\"_blank\">Grunt</a>)."
      },
      {
        "type": "h",
        "text": "Intro"
      },
      {
        "type": "p",
        "text": "Recently, I worked on a <a href=\"http://expressjs.com/\" taregt=\"_blank\">Express.js</a> based RESTful API with <a href=\"https://couchdb.apache.org/\" target=\"_blank\">CouchDB</a> storage. For various reasons, I mostly had end-to-end tests (testing HTTP endpoints) and very few unit tests. In the tests, I would rebuild the database before every <em>describe</em> block. This worked quite well but at one point I noticed that my feedback loops were beginning to get tediously slow (~30 seconds to run the full test suite). Thankfully, I discovered <a href=\"https://github.com/chris-l/mock-couch\" target=\"_blank\">mock-couch</a>: in-memory storage with CouchDB API. The switch was rather easy and, as a result, my test suite would finish in less than 10 seconds (even when reseting test data before each test)."
      },
      {
        "type": "h",
        "text": "Setup"
      },
      {
        "type": "p",
        "text": "Our sample API will expose functionality to access a database of sofa's. Let's set it up."
      },
      {
        "type": "p",
        "text": "Structure and dependencies"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "bootstrap.bash"
      },
      {
        "type": "p",
        "text": "gulpfile.coffee"
      },
      {
        "type": "code",
        "language": "coffeescript",
        "file": "1/gulpfile.coffee"
      },
      {
        "type": "p",
        "text": "server.coffee"
      },
      {
        "type": "code",
        "language": "coffeescript",
        "file": "1/server.coffee"
      },
      {
        "type": "p",
        "text": "Let's create file <i>specs/sofas.spec.coffee</i> which is going to contain our tests."
      },
      {
        "type": "code",
        "language": "coffeescript",
        "file": "1/specs/sofas.spec.coffee"
      },
      {
        "type": "p",
        "text": "If you run the tests right now, you should see similar output:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "1/test-run.txt"
      },
      {
        "type": "h",
        "text": "Database Model"
      },
      {
        "type": "p",
        "text": "Sofas will be stored in CouchDB with the following structure:"
      },
      {
        "type": "code",
        "language": "javascript",
        "file": "sofa.json.txt"
      },
      {
        "type": "p",
        "text": "With this in mind, let's build a module for accessing the database."
      },
      {
        "type": "code",
        "language": "coffeescript",
        "file": "2/dal.coffee"
      },
      {
        "type": "p",
        "text": "What's missing is the endpoint and test implementation. Let's start with the tests."
      },
      {
        "type": "code",
        "language": "bash",
        "file": "2/specs/sofas.spec.coffee"
      },
      {
        "type": "p",
        "text": "Now the endpoints:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "2/server.coffee"
      },
      {
        "type": "p",
        "text": "At this point we can execute <em>gulp test-int</em> command to run tests on real CouchDB:"
      },
      {
        "type": "code",
        "language": "coffeescript",
        "file": "2/test-int-run.txt"
      },
      {
        "type": "h",
        "text": "mock-couch tests"
      },
      {
        "type": "p",
        "text": "So how do we use mock-couch for this? Mock-couch is an HTTP server based on <a href=\"http://mcavage.me/node-restify/\" target=\"_blank\">Restify</a>. Note that <a href=\"https://nodejs.org/\" target=\"_blank\">Node.js</a> runtime is single-threaded therefore we won't be able to run both express and mock-couch at the same time. However, it is possible to run mock-couch on another process."
      },
      {
        "type": "p",
        "text": "Node provides a couple of ways to create processes out of the box. We'll use one called <a href=\"https://nodejs.org/api/child_process.html#child_process_child_process_fork_modulepath_args_options\" target=\"_blank\">forking</a>: not only we'll be able to control the lifecycle of the forked child process but we'll also have the ability to send and receive messages between parent and the child."
      },
      {
        "type": "p",
        "text": "OK, less talk and more forking. We'll do the forking in <em>gulp test</em> task:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "3/gulpfile.coffee"
      },
      {
        "type": "p",
        "text": "Also, we need a slight change to the test setup:"
      },
      {
        "type": "code",
        "language": "bash",
        "file": "3/specs/sofas.spec.coffee"
      },
      {
        "type": "h",
        "text": "Moment of Truth"
      },
      {
        "type": "p",
        "text": "If you try running <em>gulp test</em> right now, you should see similar output:"
      },
      {
        "type": "code",
        "language": "coffeescript",
        "file": "3/test-run.txt"
      },
      {
        "type": "p",
        "text": "As you can see the tests completed slightly faster than with real CouchDB. In a small code base like this, it's hardly worth switching to mock-couch, if execution speed is your only motivation. However, with bigger codebases, the speed improvement can become very apparent."
      },
      {
        "type": "p",
        "text": "Besides speed, there's another benefit to this approach: you don't actually need CouchDB to test your project. The simplified build process is especially useful with Continuous Integration platforms like <a href=\"http://travis-ci.org/\" target=\"_blank\">Travis CI</a> and <a href=\"https://codeship.com\" target=\"_blank\">Codeship</a>."
      },
      {
        "type": "h",
        "text": "Resources"
      },
      {
        "type": "p",
        "text": ""
      },
      {
        "type": "list",
        "items": {
            "0": "<a href=\"https://github.com/reederz/express-mock-couch-showcase\" target=\"_blank\">Code on GitHub</a>",
            "1": "<a href=\"https://github.com/chris-l/mock-couch\" target=\"_blank\">mock-couch</a>"
        }
      }
    ]
  }
]
